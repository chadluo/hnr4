"use client";

import { readStreamableValue } from "ai/rsc";
import * as React from "react";
import type { Flags } from "./flags.ts";
import { generateSummary } from "./generate.ts";
import type { HNStory } from "./hn.ts";

export type SummaryProps = {
  hnStory: HNStory;
  isShowing: boolean;
  flags: Flags;
};

const DEFAULT_SUMMARY = "summary";

export const Summary = ({ hnStory, isShowing, flags }: SummaryProps) => {
  const { forceRefreshSummary, fakeSummary } = flags;
  const [generation, setGeneration] = React.useState(DEFAULT_SUMMARY);

  React.useEffect(() => {
    let isGenerating = true;
    if (isShowing) {
      (async () => {
        const { id, url } = hnStory;
        if (fakeSummary || url == null) {
          setGeneration(DEFAULT_SUMMARY);
        } else {
          const { output } = await generateSummary(
            id,
            url,
            forceRefreshSummary,
          );
          for await (const delta of readStreamableValue(output)) {
            if (isGenerating) {
              setGeneration(
                (currentGeneration) => `${currentGeneration}${delta}`,
              );
            } else {
              break;
            }
          }
        }
      })();
    }
    return () => {
      isGenerating = false;
      setGeneration("");
    };
  }, [hnStory, isShowing, forceRefreshSummary, fakeSummary]);

  return (
    <span
      className="font-mono text-sm italic leading-6"
      title={
        "Summary generated by OpenAI gpt-4o-mini and may be inaccurate or incorrect."
      }
    >
      {generation}
    </span>
  );
};
