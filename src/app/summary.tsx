"use client";

import { readStreamableValue } from "@ai-sdk/rsc";
import * as React from "react";
import type { Flags } from "./flags";
import { generateSummary } from "./generate";
import type { HNStory } from "./hn";
import { model } from "./model";

export type SummaryProps = {
  hnStory: HNStory;
  isShowing: boolean;
  flags: Flags;
};

const DEFAULT_SUMMARY = "summary";

export const Summary = ({ hnStory, isShowing, flags }: SummaryProps) => {
  const { forceRefreshSummary, fakeSummary } = flags;
  const [generation, setGeneration] = React.useState(DEFAULT_SUMMARY);
  const [isGenerating, setGenerating] = React.useState(false);

  React.useEffect(() => {
    setGenerating(true);
    if (isShowing) {
      (async () => {
        const { id, url } = hnStory;
        if (fakeSummary || url == null) {
          setGeneration(DEFAULT_SUMMARY);
        } else {
          const { output } = await generateSummary(
            id,
            url,
            forceRefreshSummary,
          );
          for await (const delta of readStreamableValue(output)) {
            if (isGenerating) {
              setGeneration(
                (currentGeneration) => `${currentGeneration}${delta}`,
              );
            } else {
              break;
            }
          }
        }
        setGenerating(false);
      })();
    }
    return () => {
      setGenerating(false);
      setGeneration("");
    };
  }, [hnStory, isShowing, forceRefreshSummary, fakeSummary, isGenerating]);

  return (
    <span
      className="font-mono text-sm leading-6 italic"
      title={`Summary generated by OpenAI ${model} and may be inaccurate or incorrect.`}
    >
      {generation + (isGenerating ? "Â·" : "")}
    </span>
  );
};
